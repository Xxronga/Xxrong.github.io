

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="zhizhia">
  <meta name="keywords" content="">
  
    <meta name="description" content="MySQL-reading notes">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL读书笔记">
<meta property="og:url" content="http://example.com/2023/11/05/sql-mosh/index.html">
<meta property="og:site_name" content="Xxronga的个人博客">
<meta property="og:description" content="MySQL-reading notes">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2023/11/05/sql-mosh/image-20231105205930980.png">
<meta property="og:image" content="http://example.com/2023/11/05/sql-mosh/image-20231105205940165.png">
<meta property="og:image" content="http://example.com/2023/11/05/sql-mosh/image-20231105210011981.png">
<meta property="og:image" content="http://example.com/2023/11/05/sql-mosh/image-20231105210024049.png">
<meta property="og:image" content="http://example.com/2023/11/05/sql-mosh/image-20231026170906220.png">
<meta property="article:published_time" content="2023-11-05T12:39:55.872Z">
<meta property="article:modified_time" content="2023-11-07T08:40:55.686Z">
<meta property="article:author" content="Xxronga">
<meta property="article:tag" content="MySQL">
<meta property="article:tag" content="Coding">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2023/11/05/sql-mosh/image-20231105205930980.png">
  
  
  
  <title>MySQL读书笔记 - Xxronga的个人博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Hello</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/tree.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="MySQL读书笔记"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-11-05 12:39" pubdate>
          2023年11月5日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          25k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          212 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">MySQL读书笔记</h1>
            
            
              <div class="markdown-body">
                
                <p> MySQL-reading notes</p>
<span id="more"></span>

<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1UE41147KC/?p=8&spm_id_from=pageDriver&vd_source=50339af4080e63c88cca799f0870a5a1">https://www.bilibili.com/video/BV1UE41147KC/?p=8&amp;spm_id_from=pageDriver&amp;vd_source=50339af4080e63c88cca799f0870a5a1</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/222865842">https://zhuanlan.zhihu.com/p/222865842</a></p>
<p>💛<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/222932740">https://zhuanlan.zhihu.com/p/222932740</a></p>
<hr>
<p>数据库是一个以可轻易获取形式来存储的数据的集合</p>
<p>为了管理数据，我们使用一种叫做数据库管理系统 或DBMS 的软件应用。</p>
<p><img src="/2023/11/05/sql-mosh/image-20231105205930980.png" srcset="/img/loading.gif" lazyload alt="image-20231105205930980"></p>
<p>DBMS被归为两大类：关系型和非关系型（NoSQL）</p>
<ul>
<li><p>在<u>关系型数据库</u>中，我们把数据存储在利用关系互相链接的表中。</p>
<p><img src="/2023/11/05/sql-mosh/image-20231105205940165.png" srcset="/img/loading.gif" lazyload alt="image-20231105205940165"></p>
</li>
<li><p>在<u>非关系型数据库</u>中，我们没有表或者关系。（非关系型DBMS无法读取SQL语言）</p>
</li>
</ul>
<h1 id="数据概要"><a href="#数据概要" class="headerlink" title="数据概要"></a>数据概要</h1><p>课程一共用到四个数据库，分别是</p>
<ol>
<li>sql_invoicing（发票数据库）</li>
<li>sql_store（商店数据库）</li>
<li>sql_inventory（存货数据库）</li>
<li>sql_hr（人力资源数据库）</li>
</ol>
<p>其中，主要是前两个数据库用的比较多，后两个数据库只是在特定主题下讲过一两次，结构简单。</p>
<h2 id="1-sql-store"><a href="#1-sql-store" class="headerlink" title="1. sql_store"></a>1. sql_store</h2><h1 id="第一部分：基础–增删查改"><a href="#第一部分：基础–增删查改" class="headerlink" title="第一部分：基础–增删查改"></a>第一部分：基础–增删查改</h1><h2 id="【第一章】预备工作"><a href="#【第一章】预备工作" class="headerlink" title="【第一章】预备工作"></a>【第一章】预备工作</h2><h2 id="【第二章】在单一表格中检索数据"><a href="#【第二章】在单一表格中检索数据" class="headerlink" title="【第二章】在单一表格中检索数据"></a>【第二章】在单一表格中检索数据</h2><h3 id="1-选择语句"><a href="#1-选择语句" class="headerlink" title="1.选择语句"></a>1.选择语句</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><span class="hljs-operator">/</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span> <span class="hljs-comment">-- 纵向筛选列，甚至可以是常数</span><br><span class="hljs-keyword">FROM</span> customers <span class="hljs-comment">-- 选择表</span><br><span class="hljs-comment">-- WHERE customer_id=1 -- 横向删选表</span><br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> first_name <span class="hljs-comment">-- 排序</span><br><br><span class="hljs-comment">-- 单行注释</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">多行注释</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure>

<h3 id="2-选择子句"><a href="#2-选择子句" class="headerlink" title="2. 选择子句"></a>2. 选择子句</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><span class="hljs-keyword">SELECT</span> <br>	<span class="hljs-keyword">DISTINCT</span> last_name,<br>	first_name,<br>	points.<br>	(points <span class="hljs-operator">+</span> <span class="hljs-number">70</span>) <span class="hljs-operator">%</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AS</span> discount_factor<span class="hljs-operator">/</span><span class="hljs-string">&#x27;discount factor&#x27;</span><br><span class="hljs-keyword">FROM</span> customers<br></code></pre></td></tr></table></figure>

<h4 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- return all the products</span><br><span class="hljs-comment">-- name </span><br><span class="hljs-comment">-- unit price</span><br><span class="hljs-comment">-- new price (unit price * 1.1)</span><br><br><span class="hljs-keyword">SELECT</span><br>	name,<br>	unit_price,<br>	unit_price <span class="hljs-operator">*</span> <span class="hljs-number">1.1</span> <span class="hljs-keyword">AS</span> <span class="hljs-string">&#x27;new price&#x27;</span><br><span class="hljs-keyword">FROM</span> products<br></code></pre></td></tr></table></figure>

<h3 id="3-where-字句"><a href="#3-where-字句" class="headerlink" title="3. where 字句"></a>3. where 字句</h3><blockquote>
<p>筛选数据;</p>
<p>比较运算符 &gt;, &lt;, &#x3D;, &lt;&#x3D;, &gt;&#x3D;, !&#x3D;, &#x2F;, &lt;&gt;</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> customers<br><span class="hljs-keyword">WHERE</span> points <span class="hljs-operator">&gt;</span> <span class="hljs-number">3000</span><br><span class="hljs-operator">/</span> <span class="hljs-keyword">WHERE</span> state <span class="hljs-operator">!=</span> <span class="hljs-string">&#x27;va&#x27;</span><br></code></pre></td></tr></table></figure>

<p>也可以对日期或文本进行比较运算，注意SQL里的日期要用引号包裹</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">WHERE</span> birth_date <span class="hljs-operator">&gt;</span> <span class="hljs-string">&#x27;1990-01-01&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="4-AND-OR-NOT运算符"><a href="#4-AND-OR-NOT运算符" class="headerlink" title="4. AND, OR, NOT运算符"></a>4. AND, OR, NOT运算符</h3><p>用逻辑运算符and，or，not进行多重条件筛选执行优先级：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> customers<br><span class="hljs-keyword">WHERE</span> birth_date <span class="hljs-operator">&gt;</span> <span class="hljs-string">&#x27;1990-01-01&#x27;</span> <span class="hljs-keyword">AND</span> points <span class="hljs-operator">&gt;</span> <span class="hljs-number">1000</span><br><span class="hljs-operator">/</span><span class="hljs-keyword">WHERE</span> birth_date <span class="hljs-operator">&gt;</span> <span class="hljs-string">&#x27;1990-01-01&#x27;</span> <span class="hljs-keyword">OR</span> <br>      points <span class="hljs-operator">&gt;</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">AND</span> state <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;VA&#x27;</span><br></code></pre></td></tr></table></figure>

<p><strong>AND优先级高于OR，但最好加括号，更清晰</strong></p>
<p>NOT用法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">NOT</span> (birth_date <span class="hljs-operator">&gt;</span> <span class="hljs-string">&#x27;1990-01-01&#x27;</span> <span class="hljs-keyword">OR</span> points <span class="hljs-operator">&gt;</span> <span class="hljs-number">1000</span>)<br></code></pre></td></tr></table></figure>

<p>去括号等价于</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">WHERE</span> birth_date <span class="hljs-operator">&lt;=</span> <span class="hljs-string">&#x27;1990-01-01&#x27;</span> <span class="hljs-keyword">AND</span> points <span class="hljs-operator">&lt;=</span> <span class="hljs-number">1000</span><br></code></pre></td></tr></table></figure>

<h3 id="5-IN-运算符"><a href="#5-IN-运算符" class="headerlink" title="5. IN 运算符"></a>5. IN 运算符</h3><p>用IN运算符将某一属性<strong>与多个值（一系列值）进行比较</strong><br>实质是多重相等比较运算条件的简化</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> customers<br><span class="hljs-keyword">WHERE</span> state <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;va&#x27;</span> <span class="hljs-keyword">OR</span> state <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;fl&#x27;</span> <span class="hljs-keyword">OR</span> state <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;ga&#x27;</span><br></code></pre></td></tr></table></figure>

<p>不能 <code>state = &#39;va&#39; OR &#39;fl&#39; OR &#39;ga&#39;</code> 因为数学和比较运算优先于逻辑运算，加括号 <code>state = (&#39;va&#39; OR &#39;fl&#39; OR &#39;ga&#39;)</code> 也不行，逻辑运算符只能链接布林值。</p>
<p>用 IN 操作符简化该条件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">WHERE</span> state <span class="hljs-keyword">IN</span> (<span class="hljs-string">&#x27;va&#x27;</span>, <span class="hljs-string">&#x27;fl&#x27;</span>, <span class="hljs-string">&#x27;ga&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p>可加NOT</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">WHERE</span> state <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">&#x27;va&#x27;</span>, <span class="hljs-string">&#x27;fl&#x27;</span>, <span class="hljs-string">&#x27;ga&#x27;</span>)<br></code></pre></td></tr></table></figure>

<h3 id="6-BETWEEN运算符"><a href="#6-BETWEEN运算符" class="headerlink" title="6. BETWEEN运算符"></a>6. BETWEEN运算符</h3><p>用于表达<strong>范围</strong>型条件</p>
<blockquote>
<ul>
<li>用AND而非括号</li>
<li><strong>闭区间，包含两端点</strong></li>
<li>也可用于日期，毕竟日期本质也是数值，日期也有大小（早晚），可比较运算</li>
<li>同 IN 一样，BETWEEN 本质也是一种特定的 多重比较运算条件 的简化</li>
</ul>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> customers<br><span class="hljs-keyword">where</span> points <span class="hljs-operator">&gt;=</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">and</span> points <span class="hljs-operator">&lt;=</span> <span class="hljs-number">3000</span><br></code></pre></td></tr></table></figure>

<p>等效简化为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">WHERE</span> points <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">3000</span><br></code></pre></td></tr></table></figure>

<h3 id="7-LIKE运算符"><a href="#7-LIKE运算符" class="headerlink" title="7.LIKE运算符"></a>7.LIKE运算符</h3><p>模糊查找，查找具有某种模式的字符串的记录、行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> customers<br><span class="hljs-keyword">WHERE</span> last_name <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;brush%&#x27;</span> <span class="hljs-operator">/</span> <span class="hljs-string">&#x27;b___y&#x27;</span><br></code></pre></td></tr></table></figure>

<p>引号里写上想要的字符串模式，注意SQL几乎不区分大小写</p>
<p>两种通配符：</p>
<ul>
<li><code>%</code> 任何个数（包括0个）的字符（<strong>用的更多</strong>）</li>
<li><code>_</code> 单个字符</li>
</ul>
<p><strong>练习</strong>：</p>
<p>分别选择满足如下条件的顾客：</p>
<ol>
<li><p>地址包含 ‘TRAIL’ 或 ‘AVENUE’</p>
</li>
<li><p>电话号码以 9 结束</p>
</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> customers<br><span class="hljs-keyword">WHERE</span> address <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%Trail%&#x27;</span> <span class="hljs-keyword">OR</span> <br>	  address <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%Avenue%&#x27;</span><br>	  <br>	  <br><span class="hljs-keyword">WHERE</span> phone <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%9&#x27;</span><br></code></pre></td></tr></table></figure>

<ol start="8">
<li>REGEXP运算符</li>
</ol>
<p>正则表达式，在搜索字符串方面更为强大</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> customers<br><span class="hljs-keyword">where</span> last_name <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%field%&#x27;</span><br></code></pre></td></tr></table></figure>

<p>等效于</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">where</span> last_name regexp <span class="hljs-string">&#x27;field&#x27;</span><br></code></pre></td></tr></table></figure>

<p>正则表达式总结：</p>
<table>
<thead>
<tr>
<th>符号</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>^</td>
<td>开头</td>
</tr>
<tr>
<td>$</td>
<td>结尾</td>
</tr>
<tr>
<td>[abc]</td>
<td>含abc的任意字母</td>
</tr>
<tr>
<td>[a-c]</td>
<td>含a到c的任意字母</td>
</tr>
<tr>
<td>|</td>
<td>logical or</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">where</span> last_name regexp <span class="hljs-string">&#x27;^mac|field$|rose&#x27;</span> <br><span class="hljs-keyword">where</span> last_name regexp <span class="hljs-string">&#x27;[gi]e|e[fmq]&#x27;</span> <span class="hljs-comment">-- 查找含ge/ie或ef/em/eq的</span><br><span class="hljs-keyword">where</span> last_name regexp <span class="hljs-string">&#x27;[a-h]e|e[c-j]&#x27;</span><br></code></pre></td></tr></table></figure>

<p><strong>练习</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">分别选择满足如下条件的顾客：<br># <span class="hljs-number">1.</span> <span class="hljs-keyword">first</span> names 是 ELKA 或 AMBUR<br># <span class="hljs-number">2.</span> <span class="hljs-keyword">last</span> names 以 EY 或 <span class="hljs-keyword">ON</span> 结束<br># <span class="hljs-number">3.</span> <span class="hljs-keyword">last</span> names 以 MY 开头 或包含 SE<br># <span class="hljs-number">4.</span> <span class="hljs-keyword">last</span> names 包含 BR 或 BU<br><br><span class="hljs-keyword">where</span> first_name regexp <span class="hljs-string">&#x27;elka|ambur&#x27;</span><br><span class="hljs-keyword">where</span> last_name regexp <span class="hljs-string">&#x27;EY$|ON$&#x27;</span><br><span class="hljs-keyword">where</span> last_name regexp <span class="hljs-string">&#x27;^MY|SE&#x27;</span><br><span class="hljs-keyword">where</span> last_name regexp <span class="hljs-string">&#x27;BR|BU&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="9-IS-NULL运算符"><a href="#9-IS-NULL运算符" class="headerlink" title="9. IS NULL运算符"></a>9. IS NULL运算符</h3><p>找出空值，找出有某种属性缺失的记录</p>
<p><strong>案例</strong></p>
<p>找出电话号码缺失的顾客，也许发个邮件提醒他们之类</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> customers<br><span class="hljs-keyword">where</span> phone <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span><span class="hljs-operator">/</span><span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span><br></code></pre></td></tr></table></figure>

<p>conclusion</p>
<ul>
<li>比较运算：&gt; &lt; &#x3D; &gt;&#x3D; &lt;&#x3D; !&#x3D;</li>
<li>逻辑运算：AND, OR, NOT</li>
<li>特殊的比较运算：IN, BETWEEN, LIKE, REGEXP, IS NULL</li>
</ul>
<p><code>优先级：数学-&gt;比较-&gt;逻辑</code></p>
<h3 id="10-ORDER-BY子句"><a href="#10-ORDER-BY子句" class="headerlink" title="10. ORDER BY子句"></a>10. ORDER BY子句</h3><p>排序语句</p>
<ol>
<li>可多列（先按a排序，a相同的内部再用b排序）</li>
<li>可以是列间的数字表达式，包括没被select的列也可以作排序条件</li>
<li>也可以包含任何列&#x2F;之前定义好的别名列</li>
<li>任何一个排序依据列后面都可选DESC（降序）</li>
</ol>
<blockquote>
<p> 注：workbench 中扳手图标可打开表格的设计模式，查看或修改表中各列（属性），可以看到谁是主键。省略排序语句的话会默认按主键排序</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 订单<span class="hljs-number">2</span>的商品按总价降序排列<br>## 以总价的数学表达式为排序依据<br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> order_items<br><span class="hljs-keyword">where</span> order_id <span class="hljs-operator">=</span> <span class="hljs-number">2</span><br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> quantity <span class="hljs-operator">*</span> unit_price <span class="hljs-keyword">desc</span><br><br>## 先定义总价别名，在以别名为排序依据<br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>, quantity <span class="hljs-operator">*</span> unit_price  <span class="hljs-keyword">AS</span> total_price<br><span class="hljs-keyword">FROM</span> order_items<br><span class="hljs-keyword">where</span> order_id <span class="hljs-operator">=</span> <span class="hljs-number">2</span><br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> total_price <span class="hljs-keyword">desc</span><br></code></pre></td></tr></table></figure>

<h3 id="11-LIMIT子句"><a href="#11-LIMIT子句" class="headerlink" title="11. LIMIT子句"></a>11. LIMIT子句</h3><p>限制返回结果的记录数量，“前N个” 或 “跳过M个后的前N个”</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> customers<br>limit <span class="hljs-number">3</span> <span class="hljs-operator">/</span> <span class="hljs-number">300</span> <span class="hljs-operator">/</span> <span class="hljs-number">6</span>, <span class="hljs-number">3</span><br></code></pre></td></tr></table></figure>

<p>6, 3 表示跳过前6个，取第7~9个，6是偏移量，</p>
<h2 id="【第三章】在多张表格中检索数据"><a href="#【第三章】在多张表格中检索数据" class="headerlink" title="【第三章】在多张表格中检索数据"></a>【第三章】在多张表格中检索数据</h2><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/222968981">https://zhuanlan.zhihu.com/p/222968981</a></p>
<h3 id="1-内连接"><a href="#1-内连接" class="headerlink" title="1.内连接"></a>1.内连接</h3><p>各表分开存放是为了减少重复信息和方便修改，需要时可以根据相互之间的关系连接成相应的合并详情表以满足相应的查询。FROM JOIN ON 语句就是告诉sql： 将哪几张表以什么基础连接&#x2F;合并起来。</p>
<p>从后往前看查询语句：</p>
<ul>
<li>后面的<code>from</code> 表A <code>join</code> 表B <code>on</code> AB的关系，就是以某些相关联的列为依据，进行多表合并得到所需的详情表</li>
<li>前面的select就是在合并详情表中找到所需的列</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">select</span><br>	order_id,<br>    o.customer_id,<br>    first_name,<br>    last_name<br><span class="hljs-keyword">from</span> orders <span class="hljs-keyword">as</span> o<br><span class="hljs-keyword">join</span> customers c<br>	<span class="hljs-keyword">on</span> o.customer_id <span class="hljs-operator">=</span> c.customer_id<br></code></pre></td></tr></table></figure>

<p>之前在<code>SELECT</code>中给选定的列加别名主要是为了得到更有意义的列名，这里再<code>FROM...JOIN...</code>加别名主要是为了简化。</p>
<p><code>o.</code>是别名，是在后面的<code>FROM</code>语句里定义的，不用会报错，因为这两个表都有<code>customer_id</code>，这里指定任意一个表的都行，因为是按相同的<code>customer_id</code>来链接两个表。总之选择多种表里都有的同名列时，必须加上表名前缀来明确列的来源。</p>
<p>同时用了别名后其他地方（包括前面的<code>SELECT</code>语句，因为SQL最先执行<code>FROM...JOIN...</code>）用别名，否则会报错。因此最好先<code>SELECT * FROM</code>选择全部，等写好了<code>FROM...JOIN...ON...</code>等后面的语句，再回头去<code>SELECT</code>里细化明确需要的列。</p>
<h3 id="2-跨数据库连接（合并）"><a href="#2-跨数据库连接（合并）" class="headerlink" title="2.跨数据库连接（合并）"></a>2.跨数据库连接（合并）</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql">use sql_store;<br><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> order_items oi<br><span class="hljs-keyword">join</span> sql_inventory.products p<br>	<span class="hljs-keyword">on</span> oi.product_id <span class="hljs-operator">=</span> p.product_id<br></code></pre></td></tr></table></figure>

<p>有时需要选取不同库的表的列，其他都一样，只需要对<code>join</code>里非正在使用<code>use</code>的库的表要加上库名前缀而已。</p>
<h3 id="3-多表连接"><a href="#3-多表连接" class="headerlink" title="3.多表连接"></a>3.多表连接</h3><p><code>FROM</code>一个核心表A，用多个<code>JOIN...ON...</code>分别通过不同的链接关系链接不同的表B,C,D,…, 通过是让表B、C、D…为表A提供更详细的信息从而合并为一张详情合并版A表，即</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">FROM</span> A<br>	<span class="hljs-keyword">JOIN</span> B <span class="hljs-keyword">ON</span> AB的关系<br>	<span class="hljs-keyword">JOIN</span> C <span class="hljs-keyword">ON</span> AC的关系<br>	<span class="hljs-keyword">JOIN</span> D <span class="hljs-keyword">ON</span> AD的关系<br>	...<br></code></pre></td></tr></table></figure>

<p>将得到一个合并BCD…等表详细信息的详情合并版A表</p>
<p>Case1：订单表同时链接顾客表和订单状态表，合并为有顾客和状态信息的详细订单表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br> <span class="hljs-keyword">SELECT</span> <br> 	o.order_id,<br> 	o.order_date,<br> 	c.first_name,<br> 	c.last_name <br> 	os.name <span class="hljs-keyword">AS</span> status<br> <span class="hljs-keyword">FROM</span> orders o<br> <span class="hljs-keyword">JOIN</span> customers c <br> 	<span class="hljs-keyword">ON</span> o.customer_id <span class="hljs-operator">=</span> c.customer_id<br> <span class="hljs-keyword">JOIN</span> order_statuses os<br> 	<span class="hljs-keyword">ON</span> o.status <span class="hljs-operator">=</span> os.order_status_id 	<br></code></pre></td></tr></table></figure>

<img src="/2023/11/05/sql-mosh/image-20231105210011981.png" srcset="/img/loading.gif" lazyload alt="image-20231105210011981" style="zoom:50%;">



<h3 id="5-符合连接条件"><a href="#5-符合连接条件" class="headerlink" title="5.符合连接条件"></a>5.符合连接条件</h3><p>像订单（orders）这种表，order_id可以唯一表示一条记录</p>
<img src="/2023/11/05/sql-mosh/image-20231105210024049.png" srcset="/img/loading.gif" lazyload alt="image-20231105210024049" style="zoom:50%;">

<p>像订单项目（order_items）这种表，<strong>订单id和产品id合在一起才能唯一表示一条记录</strong>，这叫<strong>复合主键</strong>；设计模式下也可以看到这两个字段都有PK标识，订单项目备注表（order_item_notes）也是这两个复合主键，因此他们两合并时要用复合条件：</p>
<p><code>FROM</code> 表1 <code>JOIN</code> 表2 <code>ON</code> 条件1 <code>【AND】</code> 条件2</p>
<h3 id="6-隐式连接语法"><a href="#6-隐式连接语法" class="headerlink" title="6. 隐式连接语法"></a>6. 隐式连接语法</h3><p>用<code>from where</code>取代<code>from join on</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <br><span class="hljs-keyword">FROM</span> orders o<br><span class="hljs-keyword">JOIN</span> customers c<br>    <span class="hljs-keyword">ON</span> o.customer_id <span class="hljs-operator">=</span> c.customer_id<br>    <br>    <br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> orders o, customers c<br><span class="hljs-keyword">WHERE</span> o.customer_id <span class="hljs-operator">=</span> c.customer_id<br></code></pre></td></tr></table></figure>

<p>尽量别用，因为若忘记WHERE条件筛选语句，不会报错但会得到交叉合并（cross join）结果：即10条order会分别与10个customer结合，得到100条记录。最好使用显性合并语法，因为会强制要求你写合并条件ON语句，不至于漏掉。</p>
<h3 id="7-外连接"><a href="#7-外连接" class="headerlink" title="7.外连接"></a>7.外连接</h3><ol>
<li><code>(INNER) JOIN</code> 结果只包含两表的交集</li>
<li><code>LEFT/RIGHT(OUTER)JOIN</code>结果里除了交集，还包含只出现在左&#x2F;右表中的记录。</li>
</ol>
<p>展示各产品在订单项目中出现的记录和销量，也要包括没有订单的产品</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <br>    p.product_id,<br>    p.name, <span class="hljs-comment">-- 或者直接name</span><br>    oi.quantity <span class="hljs-comment">-- 或者直接quantity</span><br><span class="hljs-keyword">FROM</span> products p<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> order_items oi<br>    <span class="hljs-keyword">ON</span> p.product_id <span class="hljs-operator">=</span> oi.product_id<br></code></pre></td></tr></table></figure>

<p>当使用左连接时，所有左表的记录会被返回，不管条件正确还是错误。</p>
<h3 id="8-多表外连接"><a href="#8-多表外连接" class="headerlink" title="8.多表外连接"></a>8.多表外连接</h3><p>查询顾客、订单和发货商记录，要包括所有顾客（包括无订单的顾客），也要包括所有订单（包括未发出的）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">SELECT</span> <br>    c.customer_id,<br>    c.first_name,<br>    o.order_id,<br>    sh.name <span class="hljs-keyword">AS</span> shipper<br><span class="hljs-keyword">FROM</span> customers c<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-comment">-- 包括无订单的顾客</span><br>    <span class="hljs-keyword">ON</span> c.customer_id <span class="hljs-operator">=</span> o.customer_id<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> shippers sh  <span class="hljs-comment">-- 包括未发出的</span><br>    <span class="hljs-keyword">ON</span> o.shipper_id <span class="hljs-operator">=</span> sh.shipper_id<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> customer_id<br></code></pre></td></tr></table></figure>

<p><strong>练习</strong></p>
<p>查询 订单 + 顾客 + 发货商 + 订单状态，包括所有的订单（包括未发货的），其实就只是前两个优先级变了一下，是要看全部订单而非全部顾客了</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">SELECT</span> <br>	o.order_id,<br>	o.order_date,<br>	c.first_name <span class="hljs-keyword">AS</span> customer,<br>	sh.name <span class="hljs-keyword">AS</span> shipper,<br>	os.name <span class="hljs-keyword">AS</span> status<br><span class="hljs-keyword">FROM</span> orders o<br><span class="hljs-keyword">JOIN</span> customers c<br>	<span class="hljs-keyword">ON</span> o.customer_id <span class="hljs-operator">=</span> c.customer_id<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> shippers sh<br>	<span class="hljs-keyword">ON</span> o.shipper_id <span class="hljs-operator">=</span> sh.shipper_id<br><span class="hljs-keyword">JOIN</span> order_statuses os<br>	<span class="hljs-keyword">ON</span> o.status <span class="hljs-operator">=</span> os.order_status_id<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.order_id<br></code></pre></td></tr></table></figure>



<h3 id="9-自我外部连接"><a href="#9-自我外部连接" class="headerlink" title="9.自我外部连接"></a>9.自我外部连接</h3><p>就用前面那个员工表的例子来说，就是用<code>LEFT JOIN</code>让得到的 员工-上级 合并表也包括老板本人（老板没有上级，即<code> reports_to</code> 字段为空，如果用<code> JOIN</code> 会被筛掉，用<code> LEFT JOIN</code> 才能保留）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_hr;<br><br><span class="hljs-keyword">SELECT</span> <br>	e.employee_id,<br>    e.first_name,<br>    m.first_name <span class="hljs-keyword">AS</span> manager<br><span class="hljs-keyword">FROM</span> employees e<br>	<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> employees m<br><span class="hljs-keyword">ON</span> e.reports_to <span class="hljs-operator">=</span> m.employee_id<br></code></pre></td></tr></table></figure>

<h3 id="10-USING字句"><a href="#10-USING字句" class="headerlink" title="10.USING字句"></a>10.USING字句</h3><p>当作为合并条件（join condition）的列在两个表中有相同的列名时，可用 <code>USING (……, ……)</code> 取代 <code>ON …… AND ……</code> 予以简化，内&#x2F;外链接均可如此简化。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">SELECT</span><br>    o.order_id,<br>    c.first_name,<br>    sh.name <span class="hljs-keyword">AS</span> shipper<br><span class="hljs-keyword">FROM</span> orders o<br><span class="hljs-keyword">JOIN</span> customers c<br>    <span class="hljs-keyword">USING</span> (customer_id) <span class="hljs-comment">-- ON o.customer_id = c.customer_id</span><br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> shippers sh<br>    <span class="hljs-keyword">USING</span> (shipper_id) <span class="hljs-comment">-- ON o.shipper_id = c.shipper_id</span><br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_id<br></code></pre></td></tr></table></figure>

<p><strong>复合主键</strong>表间复合连接条件的合并也可用 USING，中间逗号隔开就行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> order_items oi<br><span class="hljs-keyword">JOIN</span> order_item_notes oin<br><br><span class="hljs-keyword">ON</span> oi.order_id <span class="hljs-operator">=</span> oin.order_Id <span class="hljs-keyword">AND</span><br>    oi.product_id <span class="hljs-operator">=</span> oin.product_id<br><span class="hljs-operator">/</span><span class="hljs-keyword">USING</span> (order_id, product_id)<br></code></pre></td></tr></table></figure>

<p><strong>练习</strong></p>
<p>sql_invoicing库里，将payments、clients、payment_methods三张表合并起来，以知道什么日期哪个顾客用什么方式付了多少钱</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><span class="hljs-keyword">SELECT</span> <br>	p.date,<br>    c.name <span class="hljs-keyword">AS</span> client,<br>    p.amount,<br>	pm.name <span class="hljs-keyword">AS</span> payment_method<br><span class="hljs-keyword">FROM</span> clients c<br><span class="hljs-keyword">JOIN</span> payments p<br>	<span class="hljs-keyword">USING</span>(client_id)<br><span class="hljs-keyword">JOIN</span> payment_methods pm<br>	<span class="hljs-keyword">ON</span> pm.payment_method_id <span class="hljs-operator">=</span> p.payment_method<br></code></pre></td></tr></table></figure>

<h3 id="11-自然连接"><a href="#11-自然连接" class="headerlink" title="11.自然连接"></a>11.自然连接</h3><p><code>NATURAL JOIN</code> 就是让MySQL自动检索同名列作为合并条件。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">SELECT</span> <br>    o.order_id,<br>    c.first_name<br><span class="hljs-keyword">FROM</span> orders o<br><span class="hljs-keyword">NATURAL</span> <span class="hljs-keyword">JOIN</span> customers c<br></code></pre></td></tr></table></figure>

<blockquote>
<p>最好别用，因为不确定合并条件是否找对了，有时会造成无法预料的问题，编程时保持对结果的<strong>控制</strong>是非常重要的</p>
<p>但也要知道有这个东西，混个脸熟，不要别人用了看不懂。</p>
</blockquote>
<h3 id="12-交叉连接"><a href="#12-交叉连接" class="headerlink" title="12.交叉连接"></a>12.交叉连接</h3><p>得到名字和产品的所有组合，因此不需要合并条件。 实际运用如：要得到尺寸和颜色的全部组合</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">SELECT</span> <br>    c.first_name <span class="hljs-keyword">AS</span> customer,<br>    p.name <span class="hljs-keyword">AS</span> product<br><span class="hljs-keyword">FROM</span> customers c<br><span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span> products p<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.first_name<br></code></pre></td></tr></table></figure>

<p>上面是显性语法，还有隐式语法，之前讲过，其实就是隐式内容并忽略WHERE子句（即合并条件）的情况，也就是把 <code>CROSS JOIN</code> 改为逗号，即 <code>FROM A CROSS JOIN B</code> 等效于 <code>FROM A, B</code>，Mosh更推荐显式语法，因为更清晰</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">SELECT</span> <br>    c.first_name,<br>    p.name<br><span class="hljs-keyword">FROM</span> customers c, products p<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.first_name<br></code></pre></td></tr></table></figure>

<h3 id="13-联合"><a href="#13-联合" class="headerlink" title="13.联合"></a>13.联合</h3><p><code>FROM …… JOIN ……</code> 可对多张表进行横向列合并，而 <code>…… UNION ……</code> 可用来按行纵向合并多个查询结果，这些查询结果可能来自相同或不同的表</p>
<ul>
<li>同一张表可通过<code>UNION</code>添加新的分类字段，即先通过分类查询并添加新的分类字段再<code>UNION</code>合并为带分类字段的新表。</li>
<li>不同表通过<code>UNION</code>合并的情况如：将一张18年的订单表和19年的订单表纵向合并起来在一张表里展示</li>
</ul>
<p>注意</p>
<ul>
<li>合并的查询结果必须列数相等，否则会报错</li>
<li>合并表里的列名由排在 UNION 前面的决定</li>
</ul>
<p>给订单表增加一个新字段——status，用以区分今年的订单和今年以前的订单</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br>    <span class="hljs-keyword">SELECT</span> <br>        order_id,<br>        order_date,<br>        <span class="hljs-string">&#x27;Active&#x27;</span> <span class="hljs-keyword">AS</span> status<br>    <span class="hljs-keyword">FROM</span> orders<br>    <span class="hljs-keyword">WHERE</span> order_date <span class="hljs-operator">&gt;=</span> <span class="hljs-string">&#x27;2019-01-01&#x27;</span><br><br><span class="hljs-keyword">UNION</span><br><br>    <span class="hljs-keyword">SELECT</span> <br>        order_id,<br>        order_date,<br>        <span class="hljs-string">&#x27;Archived&#x27;</span> <span class="hljs-keyword">AS</span> status  <span class="hljs-comment">-- Archived 归档</span><br>    <span class="hljs-keyword">FROM</span> orders<br>    <span class="hljs-keyword">WHERE</span> order_date <span class="hljs-operator">&lt;</span> <span class="hljs-string">&#x27;2019-01-01&#x27;</span>;<br>    <br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_id<br></code></pre></td></tr></table></figure>



<p>可以看出ORDER BY的优先级在UNION之后，</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>感觉本质上可以将查询语句的任何一步和任何一个层次，包括：</p>
<ol>
<li>横纵筛选 <code>SELECT ……``WHERE ……</code></li>
<li>选表 <code>FROM ……</code></li>
<li>横纵连接 <code>…… JOIN ……``…… UNION ……</code></li>
<li>排序、限制<code>ORDER BY ……``LIMIT ……</code></li>
</ol>
<p>都看作暂时生成了一张新表（虚拟表），将后续步骤都看作是在对这些新表进行进一步的操作， 这样，层次步骤就能理清，就好理解了，也才真的能从本质上掌握并灵活运用</p>
<h2 id="【第四章】插入、更新和删除数据"><a href="#【第四章】插入、更新和删除数据" class="headerlink" title="【第四章】插入、更新和删除数据"></a>【第四章】插入、更新和删除数据</h2><h3 id="1-列属性"><a href="#1-列属性" class="headerlink" title="1. 列属性"></a>1. 列属性</h3><p>点击表的扳手按钮：打开设计模式，介绍了一些表中字段&#x2F;列的属性。</p>
<p><img src="/2023/11/05/sql-mosh/image-20231026170906220.png" srcset="/img/loading.gif" lazyload alt="image-20231026170906220"></p>
<ul>
<li>Datatype：数据类型 int 整数型 varchar 可变字符</li>
<li>PK：主键</li>
<li>NN：非空值（决定该列是否可以写空值 √否）</li>
<li>AI：自动递增（通常被用在主键列，每次我们在表中插入一条新纪录，我们让MySQL在列中插入一个值，同时主键列加一）</li>
<li>Default：默认值</li>
</ul>
<h3 id="2-插入单行"><a href="#2-插入单行" class="headerlink" title="2. 插入单行"></a>2. 插入单行</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> 目标表（目标列，可选，逗号隔开）<br><span class="hljs-keyword">VALUES</span>（目标值，逗号隔开）<br></code></pre></td></tr></table></figure>

<p>法1. 若不指明列名，则插入的值必须按所有字段的顺序完整插入</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customers <span class="hljs-comment">-- 目标表</span><br><span class="hljs-keyword">VALUES</span> (<br>    <span class="hljs-keyword">DEFAULT</span>,<br>    <span class="hljs-string">&#x27;Michael&#x27;</span>,<br>    <span class="hljs-string">&#x27;Jackson&#x27;</span>,<br>    <span class="hljs-string">&#x27;1958-08-29&#x27;</span>,  <span class="hljs-comment">-- DEFAULT/NULL/&#x27;1958-08-29&#x27;</span><br>    <span class="hljs-keyword">DEFAULT</span>,<br>    <span class="hljs-string">&#x27;5225 Figueroa Mountain Rd&#x27;</span>, <br>    <span class="hljs-string">&#x27;Los Olivos&#x27;</span>,<br>    <span class="hljs-string">&#x27;CA&#x27;</span>,<br>    <span class="hljs-keyword">DEFAULT</span><br>    );<br></code></pre></td></tr></table></figure>

<p>法2. 指明列名，可跳过取默认值的列且可更改顺序，一般用这种，更清晰</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customers (<br>    address,<br>    city,<br>    state,<br>    last_name,<br>    first_name,<br>    birth_date,<br>    )<br><span class="hljs-keyword">VALUES</span> (<br>    <span class="hljs-string">&#x27;5225 Figueroa Mountain Rd&#x27;</span>,<br>    <span class="hljs-string">&#x27;Los Olivos&#x27;</span>,<br>    <span class="hljs-string">&#x27;CA&#x27;</span>,<br>    <span class="hljs-string">&#x27;Jackson&#x27;</span>,<br>    <span class="hljs-string">&#x27;Michael&#x27;</span>,    <br>    <span class="hljs-string">&#x27;1958-08-29&#x27;</span>,  <br>    )<br>```<br></code></pre></td></tr></table></figure>

<h3 id="3-插入多行"><a href="#3-插入多行" class="headerlink" title="3. 插入多行"></a>3. 插入多行</h3><p><code>VALUES ……</code> 里一行内数据用<strong>括号内逗号</strong>隔开，而多行数据用<strong>括号间逗号</strong>隔开</p>
<ul>
<li>插入多条运货商信息</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store<br><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> shippers (name)<br><span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;shipper1&#x27;</span>),<br>       (<span class="hljs-string">&#x27;shipper2&#x27;</span>),<br>       (<span class="hljs-string">&#x27;shipper3&#x27;</span>);<br></code></pre></td></tr></table></figure>

<ul>
<li>插入多条产品信息</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br>#way1<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> products <br><span class="hljs-keyword">VALUES</span> (<span class="hljs-keyword">DEFAULT</span>, <span class="hljs-string">&#x27;product1&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">10</span>),<br>       (<span class="hljs-keyword">DEFAULT</span>, <span class="hljs-string">&#x27;product2&#x27;</span>, <span class="hljs-number">2</span>, <span class="hljs-number">20</span>),<br>       (<span class="hljs-keyword">DEFAULT</span>, <span class="hljs-string">&#x27;product3&#x27;</span>, <span class="hljs-number">3</span>, <span class="hljs-number">30</span>)<br># way2<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> products(name, quantity_in_stock, unit_price)<br><span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;product1&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">10</span>),<br>	  (<span class="hljs-string">&#x27;product2&#x27;</span>,<span class="hljs-number">2</span>,<span class="hljs-number">20</span>),<br>      (<span class="hljs-string">&#x27;product3&#x27;</span>,<span class="hljs-number">3</span>,<span class="hljs-string">&#x27;30&#x27;</span>)<br>      <br></code></pre></td></tr></table></figure>

<h3 id="4-插入分级行"><a href="#4-插入分级行" class="headerlink" title="4. 插入分级行"></a>4. 插入分级行</h3><p>订单表（orders表）里的一条记录对应订单项目表（order_items表）里的多条记录，一对多，是相互关联的父子表。通过添加&#x3D;&#x3D;一条&#x3D;&#x3D;订单记录和对应的&#x3D;&#x3D;多条&#x3D;&#x3D;订单项目记录，学习如何向父子表插入分级（层）&#x2F;耦合数据（insert hierarchical data）：</p>
<ul>
<li><p>关键：在插入子表记录时，需要用内建函数 <code>LAST_INSERT_ID()</code> 获取相关父表记录的自增ID（这个例子中就是 order_id)</p>
<blockquote>
<p>内建函数：MySQL里有很多可用的内置函数，也就是可复用的代码块，各有不同的功能，注意函数名的单词之间用下划线连接</p>
<p><code>LAST_INSERT_ID()</code>：获取最新的成功的 <code>INSERT 语句</code> 中的自增id，在这个例子中就是父表里新增的 order_id.</p>
</blockquote>
</li>
</ul>
<p><strong>案例</strong></p>
<p>新增一个订单（order），里面包含两个订单项目&#x2F;两种商品（order_items），请同时更新订单表和订单项目表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (customer_id, order_date, status)<br><span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;2019-01-01&#x27;</span>, <span class="hljs-number">1</span>);<br><br><span class="hljs-comment">-- 可以先试一下用 SELECT last_insert_id() 看能否成功获取到的最新的 order_id</span><br><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> order_items  <span class="hljs-comment">-- 全是必须字段，就不用指定了</span><br><span class="hljs-keyword">VALUES</span> <br>    (last_insert_id(), <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2.5</span>),<br>    (last_insert_id(), <span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1.5</span>)<br></code></pre></td></tr></table></figure>



<h3 id="5-创建表的副本"><a href="#5-创建表的副本" class="headerlink" title="5. 创建表的副本"></a>5. 创建表的副本</h3><p>CREAT TABLE 新表名 AS 子查询</p>
<p><code>主键不会复制</code></p>
<p><strong>案例1</strong></p>
<p>运用 <code>CREAT TABLE 新表名 AS 子查询</code> 快速创建表 orders 的副本表 orders_archived</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders_archived <span class="hljs-keyword">AS</span><br>    <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders  <span class="hljs-comment">-- 子查询</span><br></code></pre></td></tr></table></figure>

<p><code>SELECT * FROM orders</code> 选择了 oders 中所有数据，作为AS的内容，是一个子查询</p>
<ul>
<li>子查询： 任何一个充当另一个SQL语句的一部分的 <code>SELECT……</code> 查询语句都是子查询，子查询是一个很有用的技巧</li>
</ul>
<p><strong>案例2</strong></p>
<p>不再用全部数据，而选用原表中部分数据创建副本表，如今年以前的orders创建一个副本orders_archived，其实就是在子查询中增加了一个where语句进行筛选。&#96;注意要先drop删掉或truncate清空掉之前的orders_archive表再重建或重新插入数据。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> orders_archived;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders_archived <span class="hljs-keyword">AS</span><br>    <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders  <span class="hljs-comment">-- 子查询</span><br>    <span class="hljs-keyword">WHERE</span> order_date <span class="hljs-operator">&lt;</span> <span class="hljs-string">&#x27;2019-01-01&#x27;</span><br></code></pre></td></tr></table></figure>

<p><strong>练习</strong></p>
<p>创建一个存档发票表，只包含有过支付记录的发票并将顾客id换成顾客名字</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs SQL">USE sql_invoicing;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> invoices_archived <span class="hljs-keyword">AS</span><br>	<span class="hljs-keyword">SELECT</span> i.invoice_id, c.name <span class="hljs-keyword">AS</span> client, i.payment_date<br>	<span class="hljs-keyword">FROM</span> invoices i<br>	<span class="hljs-keyword">JOIN</span> clients c<br>		<span class="hljs-keyword">USING</span> (client_id)<br>	<span class="hljs-keyword">WHERE</span> i.payment_date <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br></code></pre></td></tr></table></figure>



<h3 id="6-更新单行"><a href="#6-更新单行" class="headerlink" title="6. 更新单行"></a>6. 更新单行</h3><p>用 <code>UPDATE ……</code> 语句 来修改表中的一条或多条记录，具体语法结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">UPDATE</span> 表 <br><span class="hljs-keyword">SET</span> 要修改的字段 <span class="hljs-operator">=</span> 具体值<span class="hljs-operator">/</span><span class="hljs-keyword">NULL</span><span class="hljs-operator">/</span><span class="hljs-keyword">DEFAULT</span><span class="hljs-operator">/</span>列间数学表达式 （修改多个字段用逗号分隔）<br><span class="hljs-keyword">WHERE</span> 行筛选<br></code></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">UPDATE</span> invoices<br><span class="hljs-keyword">SET</span> <br>    payment_total <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-operator">/</span> <span class="hljs-number">0</span> <span class="hljs-operator">/</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-operator">/</span> <span class="hljs-keyword">NULL</span> <span class="hljs-operator">/</span> <span class="hljs-number">0.5</span> <span class="hljs-operator">*</span> invoice_total, <br>    <span class="hljs-comment">/*注意 0.5 * invoice_total 的结果小数部分会被舍弃，</span><br><span class="hljs-comment">    之后讲数据类型会讲到这个问题*/</span><br>    payment_date <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2019-01-01&#x27;</span> <span class="hljs-operator">/</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-operator">/</span> <span class="hljs-keyword">NULL</span> <span class="hljs-operator">/</span> due_date<br><span class="hljs-keyword">WHERE</span> invoice_id <span class="hljs-operator">=</span> <span class="hljs-number">3</span><br></code></pre></td></tr></table></figure>

<h3 id="7-更新多行"><a href="#7-更新多行" class="headerlink" title="7. 更新多行"></a>7. 更新多行</h3><p>语法一样的，就是让 <code>WHERE……</code> 的条件包含更多记录，就会同时更改多条记录了</p>
<p><strong>注意</strong></p>
<p>Workbench默认开启了Safe Updates功能，不允许同时更改多条记录，要先关闭该功能（在 Edit-Preferences-SQL Editor-Safe Updates）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">UPDATE</span> invoices<br><span class="hljs-keyword">SET</span> payment_total <span class="hljs-operator">=</span> <span class="hljs-number">233</span>, payment_date <span class="hljs-operator">=</span> due_date<br><span class="hljs-keyword">WHERE</span> client_id <span class="hljs-operator">=</span> <span class="hljs-number">3</span>  <br><span class="hljs-comment">-- 该客户的发票记录不止一条，将同时更改</span><br><span class="hljs-operator">/</span><span class="hljs-keyword">WHERE</span> client_id <span class="hljs-keyword">IN</span> (<span class="hljs-number">3</span>, <span class="hljs-number">4</span>) <br><span class="hljs-comment">-- 第二章 4~9 讲的那些写 WHERE 条件的方法均可用</span><br><span class="hljs-comment">-- 甚至可以直接省略 WHERE 语句，会直接更改整个表的全部记录</span><br></code></pre></td></tr></table></figure>

<h3 id="8-在updates中用子查询"><a href="#8-在updates中用子查询" class="headerlink" title="8. 在updates中用子查询"></a>8. 在updates中用子查询</h3><p>本质上是将子查询用在<code>where</code>行筛选条件中</p>
<p><strong>案例</strong></p>
<p>更改发票记录表中名字叫 Yadel 的记录，但该表只有 client_id，故先要从另一个顾客表中查询叫 Yadel 人的 client_id</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">UPDATE</span> invoices<br><span class="hljs-keyword">SET</span> payment_total <span class="hljs-operator">=</span> <span class="hljs-number">233</span>, payment_date <span class="hljs-operator">=</span> due_date<br><span class="hljs-keyword">WHERE</span> client_id <span class="hljs-operator">=</span> (<br>	<span class="hljs-keyword">SELECT</span> client_id<br>	<span class="hljs-keyword">FROM</span> clients <br>	<span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Myworks&#x27;</span>)<br>	  <span class="hljs-comment">-- 放入括号，确保先执行</span><br><br><span class="hljs-comment">-- 若子查询返回多个数据（一列多条数据）时就不能用等号而要用 IN 了：</span><br><span class="hljs-keyword">WHERE</span> client_id <span class="hljs-keyword">IN</span> <br>    (<span class="hljs-keyword">SELECT</span> client_id <br>    <span class="hljs-keyword">FROM</span> clients<br>    <span class="hljs-keyword">WHERE</span> state <span class="hljs-keyword">IN</span> (<span class="hljs-string">&#x27;CA&#x27;</span>, <span class="hljs-string">&#x27;NY&#x27;</span>))<br></code></pre></td></tr></table></figure>



<p>确保WHERE行筛选条件准确准确无误后，再放到修改语句后执行修改：</p>
<h3 id="9-删除行"><a href="#9-删除行" class="headerlink" title="9. 删除行"></a>9. 删除行</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> 表 <br><span class="hljs-keyword">WHERE</span> 行筛选条件<br>（当然也可用子查询）<br>（若省略 <span class="hljs-keyword">WHERE</span> 条件语句会删除表中所有记录（和 <span class="hljs-keyword">TRUNCATE</span> 等效？））<br></code></pre></td></tr></table></figure>

<h3 id="10-恢复数据库"><a href="#10-恢复数据库" class="headerlink" title="10. 恢复数据库"></a>10. 恢复数据库</h3><p>Restoring the Databases (1:06)</p>
<p>就是重新运行那个 create-databases.sql 文件以重置数据库</p>
<h1 id="第二部分：基础进阶–汇总、复杂查询、内置函数"><a href="#第二部分：基础进阶–汇总、复杂查询、内置函数" class="headerlink" title="第二部分：基础进阶–汇总、复杂查询、内置函数"></a>第二部分：基础进阶–汇总、复杂查询、内置函数</h1><h2 id="【第五章】汇总数据"><a href="#【第五章】汇总数据" class="headerlink" title="【第五章】汇总数据"></a>【第五章】汇总数据</h2><h3 id="聚合函数"><a href="#聚合函数" class="headerlink" title="聚合函数"></a>聚合函数</h3><p>聚合函数：<strong>输入一系列值并聚合为一个结果</strong>的函数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">SELECT</span> <br>    <span class="hljs-built_in">MAX</span>(invoice_date) <span class="hljs-keyword">AS</span> latest_date,  <br>    <span class="hljs-comment">-- SELECT选择的不仅可以是列，也可以是数字、列间表达式、列的聚合函数</span><br>    <span class="hljs-built_in">MIN</span>(invoice_total) lowest,<br>    <span class="hljs-built_in">AVG</span>(invoice_total) average,<br>    <span class="hljs-built_in">SUM</span>(invoice_total <span class="hljs-operator">*</span> <span class="hljs-number">1.1</span>) total,<br>    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) total_records,<br>    <span class="hljs-built_in">COUNT</span>(invoice_total) number_of_invoices, <br>    <span class="hljs-comment">-- 和上一个相等</span><br>    <span class="hljs-built_in">COUNT</span>(payment_date) number_of_payments,  <br>    <span class="hljs-comment">-- 【聚合函数会忽略空值】，得到的支付数少于发票数</span><br>    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> client_id) number_of_distinct_clients<br>    <span class="hljs-comment">-- DISTINCT client_id 筛掉了该列的重复值，再COUNT计数，会得到不同顾客数</span><br><span class="hljs-keyword">FROM</span> invoices<br><span class="hljs-keyword">WHERE</span> invoice_date <span class="hljs-operator">&gt;</span> <span class="hljs-string">&#x27;2019-07-01&#x27;</span>  <span class="hljs-comment">-- 想只统计下半年的结果</span><br></code></pre></td></tr></table></figure>



<h3 id="GROUP-BY-子句"><a href="#GROUP-BY-子句" class="headerlink" title="GROUP BY 子句"></a>GROUP BY 子句</h3><p>按一列或多列分组，注意语句的位置。</p>
<ul>
<li>案例1：按一个字段分组</li>
</ul>
<p>在发票记录表中<strong>按不同顾客分组统计</strong>下半年总销售额并降序排列</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">SELECT</span> <br>    client_id,  #只有聚合函数是按 client_id 分组时，这里选择 client_id 列才有意义（分组统计语句里<span class="hljs-keyword">SELECT</span>通常都是选择分组依据列<span class="hljs-operator">+</span>目标统计列的聚合函数，选别的列没意义）<br>    <span class="hljs-built_in">SUM</span>(invoice_total) <span class="hljs-keyword">AS</span> total_sales<br><span class="hljs-keyword">FROM</span> invoices<br><span class="hljs-keyword">WHERE</span> invoice_date <span class="hljs-operator">&gt;=</span> <span class="hljs-string">&#x27;2019-07-01&#x27;</span>  <span class="hljs-comment">-- 筛选，过滤器</span><br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> client_id  <span class="hljs-comment">-- 分组</span><br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> invoice_total <span class="hljs-keyword">DESC</span><br><br></code></pre></td></tr></table></figure>

<p><code>select—from—where—group by—order by</code></p>
<ul>
<li>案例2：按多个字段分组</li>
</ul>
<p>算<strong>各州各城市</strong>的总销售额</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">SELECT</span> <br>	state,<br>	city, <br>	<span class="hljs-built_in">SUM</span>(invoce_total) <span class="hljs-keyword">AS</span> total_sales<br><span class="hljs-keyword">FROM</span> invoices<br><span class="hljs-keyword">JOIN</span> clients <span class="hljs-keyword">USING</span>(client_id)<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> state,city<br></code></pre></td></tr></table></figure>

<h3 id="HAVING-子句"><a href="#HAVING-子句" class="headerlink" title="HAVING 子句"></a>HAVING 子句</h3><p>HAVING 和 WHERE 都是条件筛选语句，条件的写法相通，数学、比较（包括特殊比较）、逻辑运算都可以用（如 AND、REGEXP 等等）</p>
<p>区别</p>
<ul>
<li>where是对from…join…里原表中的列进行事前筛选，所以WHERE可以对没选择的列进行筛选，所以必须用原表列名而不能用select确定的列别名。</li>
<li>而having…对select…查询后（通常是分组并聚合查询后）的结果列进行筛选，若SELECT里起了别名的字段则必须用别名进行筛选，且不能对SELECT里未选择的字段进行筛选。</li>
</ul>
<p><strong>案例</strong></p>
<p>筛选出总发票金额大于500且总发票数量大于5的顾客</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">SELECT</span> <br>    client_id,<br>    <span class="hljs-built_in">SUM</span>(invoice_total) <span class="hljs-keyword">AS</span> total_sales,<br>    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span><span class="hljs-operator">/</span>invoice_total<span class="hljs-operator">/</span>invoice_date) <span class="hljs-keyword">AS</span> number_of_invoices<br><span class="hljs-keyword">FROM</span> invoices<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> client_id<br><span class="hljs-keyword">HAVING</span> total_sales <span class="hljs-operator">&gt;</span> <span class="hljs-number">500</span> <span class="hljs-keyword">AND</span> number_of_invoices <span class="hljs-operator">&gt;</span> <span class="hljs-number">5</span><br><span class="hljs-comment">-- 均为 SELECT 里的列别名</span><br></code></pre></td></tr></table></figure>



<p>练习</p>
<p>在 sql_store 数据库（有顾客表、订单表、订单项目表等）中，找出在 ‘VA’ 州且消费总额超过100美元的顾客（这是一个面试级的问题，还很常见）</p>
<p>思路：</p>
<ol>
<li>需要的信息在顾客表、订单表、订单项目表三张表中，先将三张表合并</li>
<li>WHERE 事前筛选 ‘VA’ 州的</li>
<li>按顾客分组，并选取所需的列并聚合得到每位顾客的付款总额</li>
<li>HAVING 事后筛选超过 100美元 的</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">SELECT</span> <br>    client_id,<br>    <span class="hljs-built_in">SUM</span>(invoice_total) <span class="hljs-keyword">AS</span> total_sales,<br>    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span><span class="hljs-operator">/</span>invoice_total<span class="hljs-operator">/</span>invoice_date) <span class="hljs-keyword">AS</span> number_of_invoices<br><span class="hljs-keyword">FROM</span> invoices<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> client_id<br><span class="hljs-keyword">HAVING</span> total_sales <span class="hljs-operator">&gt;</span> <span class="hljs-number">500</span> <span class="hljs-keyword">AND</span> number_of_invoices <span class="hljs-operator">&gt;</span> <span class="hljs-number">5</span><br><span class="hljs-comment">-- 均为 SELECT 里的列别名</span><br></code></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">SELECT</span><br>	customer_id,<br>	c.first_name,<br>	c.last_name,<br>	<span class="hljs-built_in">SUM</span>(oi.quantity <span class="hljs-operator">*</span> oi.unit_price) <span class="hljs-keyword">AS</span> total_sales<br><span class="hljs-keyword">FROM</span> customers c<br><span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">USING</span>(customer_id)<br><span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">USING</span>(order_id)<br><span class="hljs-keyword">WHERE</span> state <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;VA&#x27;</span><br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <br>	customer_id,<br>	c.first_name,<br>	c.last_name<br><span class="hljs-keyword">HAVING</span> total_sales <span class="hljs-operator">&gt;</span> <span class="hljs-number">100</span><br></code></pre></td></tr></table></figure>



<h3 id="ROLLUP运算符"><a href="#ROLLUP运算符" class="headerlink" title="ROLLUP运算符"></a>ROLLUP运算符</h3><p><code>group by... with roll up</code> 自动汇总型分组，若是多字段分组汇总也是<u>多层次</u>的。</p>
<p>例1：分组查询各州、市的总销售额（发票总额）以及州层次和全国层次的两个层次的汇总额</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <br>    state,<br>    city,<br>    <span class="hljs-built_in">SUM</span>(invoice_total) <span class="hljs-keyword">AS</span> total_sales<br><span class="hljs-keyword">FROM</span> invoices<br><span class="hljs-keyword">JOIN</span> clients <span class="hljs-keyword">USING</span> (client_id) <br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> state, city <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">ROLLUP</span><br></code></pre></td></tr></table></figure>

<p>例2：分组计算各个付款方式的总付款并汇总</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">SELECT</span> <br>	pm.name <span class="hljs-keyword">AS</span> payment_method,<br>    <span class="hljs-built_in">SUM</span>(amount) <span class="hljs-keyword">AS</span> total<br><span class="hljs-keyword">FROM</span> payments p<br><span class="hljs-keyword">JOIN</span> payment_methods pm<br>	<span class="hljs-keyword">ON</span> pm.payment_method_id <span class="hljs-operator">=</span> p.payment_id<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> pm.name <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">ROLLUP</span><br></code></pre></td></tr></table></figure>

<p><strong>★总结</strong></p>
<p>根据之后三篇参考文章，据说标准的 SQL 查询语句的执行顺序应该是下面这样的：</p>
<ol>
<li>FROM JOIN 选择和连接本次查询所需的表</li>
<li>ON&#x2F;USING WHERE 按条件筛选行</li>
<li>GROUP BY 分组</li>
<li>SELECT 筛选列<br>  注意1：若进行了分组，这一步常常要聚合<br>  注意2：SELECT 和 HAVING 在 MySQL 里的执行顺序我还有点疑问，见后面的叙述</li>
<li>HAVING （事后&#x2F;分组后）筛选行</li>
<li>DISTINCT 去重</li>
<li>UNION 纵向合并</li>
<li>ORDER BY 排序</li>
<li>LIMIT 限制</li>
</ol>
<p>“SELECT 是在大部分语句执行了之后才执行的，严格的说是在 FROM、WHERE 和 GROUP BY 之后执行的。理解这一点是非常重要的，<strong>这就是你不能在 WHERE 中使用在 SELECT 中设定别名的字段作为判断条件的原因。</strong>“</p>
<p>而 HAVING 必须用 SELECT 选中列（聚合函数除外）</p>
<h2 id="【第六章】编写复杂查询"><a href="#【第六章】编写复杂查询" class="headerlink" title="【第六章】编写复杂查询"></a>【第六章】编写复杂查询</h2><h3 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h3><p>子查询： 任何一个充当另一个SQL语句的一部分的 SELECT…… 查询语句都是子查询，子查询是一个很有用的技巧。子查询的层级用括号实现。</p>
<p>例1：在 products 中，找到所有比生菜（id &#x3D; 3）价格高的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> products<br><span class="hljs-keyword">WHERE</span> unit_price <span class="hljs-operator">&gt;</span> (<br>	<span class="hljs-keyword">SELECT</span> unit_price<br>    <span class="hljs-keyword">FROM</span> products<br>    <span class="hljs-keyword">WHERE</span> product_id <span class="hljs-operator">=</span> <span class="hljs-number">3</span>)<br></code></pre></td></tr></table></figure>

<p>MySQL执行时会先执行括号内的子查询（内查询），将获得的生菜价格作为结果返回给外查询</p>
<p>子查询不仅可用在 WHERE …… 中，也可用在 SELECT …… 或 FROM …… 等子句中，本章后面会讲</p>
<h3 id="IN运算符"><a href="#IN运算符" class="headerlink" title="IN运算符"></a>IN运算符</h3><p>在 sql_store 库 products 表中找出那些从未被订购过的产品</p>
<p>思路：</p>
<ul>
<li>order_items 表里有所有产品被订购的记录，用 DISTINCT 去重，得到所有被订购过的产品列表</li>
<li>不在这列表里（NOT IN 的使用）的产品即为从未被订购过的产品</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> products<br><span class="hljs-keyword">WHERE</span> product_id <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (<br>    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> product_id<br>    <span class="hljs-keyword">FROM</span> order_items<br>)<br></code></pre></td></tr></table></figure>

<h3 id="4-子查询-vs-连接"><a href="#4-子查询-vs-连接" class="headerlink" title="4.子查询 vs 连接"></a>4.子查询 vs 连接</h3><p><strong>案例</strong></p>
<p>上节课的案例，找出从未订购（没有invoices）的顾客：</p>
<p>法1. 子查询</p>
<p>先用子查询查出有过发票记录的顾客名单，作为筛选依据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> clients<br><span class="hljs-keyword">WHERE</span> client_id <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (<br>    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> client_id<br>    <span class="hljs-comment">/*其实这里加不加DISTINCT对子查询返回的结果有影响</span><br><span class="hljs-comment">    但对最后的结果其实没有影响*/</span><br>    <span class="hljs-keyword">FROM</span> invoices<br>)<br></code></pre></td></tr></table></figure>

<p>法2. 链接表</p>
<p>用顾客表 LEFT JOIN 发票记录表，再直接在这个合并详情表中筛选出没有发票记录的顾客</p>
<p><code>只有合起来，我们才知道顾客有没有发票记录；同时如果使用内链接，会自动把没有发票记录的筛掉</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> client_id, name …… <br><span class="hljs-comment">-- 不能SELECT DISTINCT *</span><br><span class="hljs-keyword">FROM</span> clients<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> invoices <span class="hljs-keyword">USING</span> (client_id)<br><span class="hljs-comment">-- 注意不能用内链接，否则没有发票记录的顾客（我们的目标）直接就被筛掉了</span><br><span class="hljs-keyword">WHERE</span> invoice_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span><br></code></pre></td></tr></table></figure>









<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">SELECT</span> <br>    client_id,<br>    <span class="hljs-built_in">SUM</span>(invoice_total) <span class="hljs-keyword">AS</span> total_sales,<br>    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span><span class="hljs-operator">/</span>invoice_total<span class="hljs-operator">/</span>invoice_date) <span class="hljs-keyword">AS</span> number_of_invoices<br><span class="hljs-keyword">FROM</span> invoices<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> client_id<br><span class="hljs-keyword">HAVING</span> total_sales <span class="hljs-operator">&gt;</span> <span class="hljs-number">500</span> <span class="hljs-keyword">AND</span> number_of_invoices <span class="hljs-operator">&gt;</span> <span class="hljs-number">5</span><br><span class="hljs-comment">-- 均为 SELECT 里的列别名</span><br></code></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><br><span class="hljs-keyword">SELECT</span> customer_id, first_name, last_name<br><span class="hljs-keyword">FROM</span> customers<br><span class="hljs-keyword">WHERE</span> customer_id <span class="hljs-keyword">IN</span> (<br>	<span class="hljs-keyword">SELECT</span> customer_id<br>	<span class="hljs-keyword">FROM</span> orders<br>	<span class="hljs-keyword">WHERE</span> order_id <span class="hljs-keyword">IN</span> (<br>		<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> order_id<br>		<span class="hljs-keyword">FROM</span> order_items<br>		<span class="hljs-keyword">WHERE</span> product_id <span class="hljs-operator">=</span> <span class="hljs-number">3</span><br>		)<br>	)<br>	<br>	<span class="hljs-comment">------</span><br><span class="hljs-keyword">SELECT</span> customer_id, first_name, last_name<br><span class="hljs-keyword">FROM</span> customers<br><span class="hljs-keyword">WHERE</span> customer_id <span class="hljs-keyword">IN</span> (<br>	<span class="hljs-keyword">SELECT</span> customer_id<br>	<span class="hljs-keyword">FROM</span> orders<br>    <span class="hljs-keyword">JOIN</span> order_items <span class="hljs-keyword">USING</span>(order_id)<br>	<span class="hljs-keyword">WHERE</span> product_id <span class="hljs-operator">=</span> <span class="hljs-number">3</span><br>		)<br>	<span class="hljs-comment">-------</span><br>USE sql_store;<br><span class="hljs-keyword">SELECT</span> customer_id, first_name, last_name<br><span class="hljs-keyword">FROM</span> customers<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders <span class="hljs-keyword">USING</span>(customer_id)<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> order_items <span class="hljs-keyword">USING</span>(order_id)	<br><span class="hljs-keyword">WHERE</span> product_id <span class="hljs-operator">=</span> <span class="hljs-number">3</span><br>		<br>	<br></code></pre></td></tr></table></figure>



<h3 id="5-ALL关键词"><a href="#5-ALL关键词" class="headerlink" title="5. ALL关键词"></a>5. ALL关键词</h3><p><code>&gt; (MAX (……))</code> 和 <code>&gt; ALL(……)</code> 等效可互换</p>
<p>“比这里面最大的还大” &#x3D; “比这里面的所有的都大”</p>
<p><strong>案例</strong></p>
<p>sql_invoicing 库中，选出金额大于3号顾客所有发票金额（或3号顾客最大发票金额） 的发票</p>
<p>法1. 用MAX关键字</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> invoices<br><span class="hljs-keyword">WHERE</span> invoice_total <span class="hljs-operator">&gt;</span> (<br>    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MAX</span>(invoice_total)<br>    <span class="hljs-keyword">FROM</span> invoices<br>    <span class="hljs-keyword">WHERE</span> client_id <span class="hljs-operator">=</span> <span class="hljs-number">3</span><br>)<br></code></pre></td></tr></table></figure>

<p>法2. 用ALL关键字</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> invoices<br><span class="hljs-keyword">WHERE</span> invoice_total <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALL</span> (<br>    <span class="hljs-keyword">SELECT</span> invoice_total<br>    <span class="hljs-keyword">FROM</span> invoices<br>    <span class="hljs-keyword">WHERE</span> client_id <span class="hljs-operator">=</span> <span class="hljs-number">3</span><br>)<br></code></pre></td></tr></table></figure>

<p>其实就是把内层括号的MAX拿到了外层括号变成ALL：</p>
<h3 id="6-ANY关键词"><a href="#6-ANY关键词" class="headerlink" title="6.ANY关键词"></a>6.ANY关键词</h3><p><code>&gt; ANY/SOME(...)</code>与<code>&gt; (MIN(...))</code>等效</p>
<p><code>=ANY/SOME(...)</code>与<code>IN(...)</code>等效</p>
<h3 id="7-相关子查询"><a href="#7-相关子查询" class="headerlink" title="7. 相关子查询"></a>7. 相关子查询</h3><p><strong>案例</strong></p>
<p>选出 sql_hr.employees 里那些工资超过<strong>他所在</strong>办公室平均工资（而不是整体平均工资）的员工<br>关键：如何查询目前主查询员工的所在办公室的平均工资而不是整体的平均工资？<br>思路：给主查询 employees表 设置别名 e，这样在子查询查询平均工资时加上 <code>WHERE office_id = e.office_id</code> 筛选条件即可相关联地查询到目前员工所在地办公室的平均工资</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_hr;<br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> employees e  <span class="hljs-comment">-- 关键 1</span><br><span class="hljs-keyword">WHERE</span> salary <span class="hljs-operator">&gt;</span> (<br>    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">AVG</span>(salary)<br>    <span class="hljs-keyword">FROM</span> employees<br>    <span class="hljs-keyword">WHERE</span> office_id <span class="hljs-operator">=</span> e.office_id  <span class="hljs-comment">-- 关键 2</span><br>    <span class="hljs-comment">-- 【子查询表字段不用加前缀，主查询表的字段要加前缀，以此区分】</span><br>)<br></code></pre></td></tr></table></figure>

<p>之前都是非关联主&#x2F;子（外&#x2F;内）查询，比如子查询先查出整体的某平均值或满足某些条件的一列id，作为主查询的筛选依据，这种子查询与主查询无关，会先一次性得出查询结果再返回给主查询供其使用。</p>
<p>而下面这种相关联子查询例子里，子查询要查询的是某员工所在办公室的平均值，子查询是依赖主查询的，<strong>注意这种关联查询是在主查询的每一行&#x2F;每一条记录层面上依次进行的</strong>，这一点可以为我们写关联子查询提供线索（注意表别名的使用），另外也正因为这一点，相关子查询会比非关联查询执行起来慢一些。</p>
<h3 id="8-EXISTS-运算符"><a href="#8-EXISTS-运算符" class="headerlink" title="8.EXISTS 运算符"></a>8.EXISTS 运算符</h3><p><code>IN + 子查询</code> 等效于 <code>EXIST + 相关子查询</code>，如果前者子查询的结果集过大占用内存，用后者逐条验证更有效率。另外 EXIST() 本质上是根据是否为空返回 TRUE 和 FALSE，所以也可以加 NOT 取反。</p>
<p><strong>案例</strong></p>
<p>找出有过发票记录的客户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">SELECT</span> <br>    client_id,<br>    <span class="hljs-built_in">SUM</span>(invoice_total) <span class="hljs-keyword">AS</span> total_sales,<br>    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span><span class="hljs-operator">/</span>invoice_total<span class="hljs-operator">/</span>invoice_date) <span class="hljs-keyword">AS</span> number_of_invoices<br><span class="hljs-keyword">FROM</span> invoices<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> client_id<br><span class="hljs-keyword">HAVING</span> total_sales <span class="hljs-operator">&gt;</span> <span class="hljs-number">500</span> <span class="hljs-keyword">AND</span> number_of_invoices <span class="hljs-operator">&gt;</span> <span class="hljs-number">5</span><br><span class="hljs-comment">-- 均为 SELECT 里的列别名</span><br></code></pre></td></tr></table></figure>





<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">SELECT</span> <br>    client_id,<br>    <span class="hljs-built_in">SUM</span>(invoice_total) <span class="hljs-keyword">AS</span> total_sales,<br>    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span><span class="hljs-operator">/</span>invoice_total<span class="hljs-operator">/</span>invoice_date) <span class="hljs-keyword">AS</span> number_of_invoices<br><span class="hljs-keyword">FROM</span> invoices<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> client_id<br><span class="hljs-keyword">HAVING</span> total_sales <span class="hljs-operator">&gt;</span> <span class="hljs-number">500</span> <span class="hljs-keyword">AND</span> number_of_invoices <span class="hljs-operator">&gt;</span> <span class="hljs-number">5</span><br><span class="hljs-comment">-- 均为 SELECT 里的列别名</span><br></code></pre></td></tr></table></figure>





<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">SELECT</span> <br>    client_id,<br>    <span class="hljs-built_in">SUM</span>(invoice_total) <span class="hljs-keyword">AS</span> total_sales,<br>    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span><span class="hljs-operator">/</span>invoice_total<span class="hljs-operator">/</span>invoice_date) <span class="hljs-keyword">AS</span> number_of_invoices<br><span class="hljs-keyword">FROM</span> invoices<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> client_id<br><span class="hljs-keyword">HAVING</span> total_sales <span class="hljs-operator">&gt;</span> <span class="hljs-number">500</span> <span class="hljs-keyword">AND</span> number_of_invoices <span class="hljs-operator">&gt;</span> <span class="hljs-number">5</span><br><span class="hljs-comment">-- 均为 SELECT 里的列别名</span><br></code></pre></td></tr></table></figure>





<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">SELECT</span> <br>    client_id,<br>    <span class="hljs-built_in">SUM</span>(invoice_total) <span class="hljs-keyword">AS</span> total_sales,<br>    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span><span class="hljs-operator">/</span>invoice_total<span class="hljs-operator">/</span>invoice_date) <span class="hljs-keyword">AS</span> number_of_invoices<br><span class="hljs-keyword">FROM</span> invoices<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> client_id<br><span class="hljs-keyword">HAVING</span> total_sales <span class="hljs-operator">&gt;</span> <span class="hljs-number">500</span> <span class="hljs-keyword">AND</span> number_of_invoices <span class="hljs-operator">&gt;</span> <span class="hljs-number">5</span><br><span class="hljs-comment">-- 均为 SELECT 里的列别名</span><br></code></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># way1: 子查询<br>USE sql_invoicing;<br>SELECT *<br>FROM client<br>WHERE client_id IN (<br>	SELECT DISTINCT client_id<br>	FROM invoices<br>)<br># way2：链接表<br>USE sql_invoicing;<br>SELECT DISTINCT client_id, name, ...<br>FROM clients<br>JOIN invoices USING(client_id)<br><br>#EXISTS运算符<br>USE sql_invoicing;<br><br>SELECT *<br>FROM clients c<br>WHERE EXISTS (<br>    SELECT */client_id  <br>    /* 就这个子查询的目的来说，SELECT的选择不影响结果，<br>    因为EXISTS()函数只根据是否为空返回 TRUE 和 FALSE */<br>    FROM invoices<br>    WHERE client_id = c.client_id<br>)<br></code></pre></td></tr></table></figure>





<p>这还是个相关子查询，因为在其中引用了主查询的 clients 表。这同样是按照主查询的记录一条条验证执行的。具体说来，对于 clients 表（设置别名为 c）里的每一个顾客，子查询在 invoices 表查找这个人的发票记录（ 即 client_id &#x3D; c.client_id 的发票记录），有就返回相关记录否者返回空，然后 EXISTS() 根据是否为空得到 TRUE 和 FALSE（表示此人有无发票记录），然后主查询凭此确定是否保留此条记录。</p>
<h3 id="9-SELECT字句的子查询"><a href="#9-SELECT字句的子查询" class="headerlink" title="9. SELECT字句的子查询"></a>9. SELECT字句的子查询</h3><p>不仅 WHERE 筛选条件里可以用子查询，SELECT 选择子句和 FROM 来源表子句也能用子查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">SELECT</span> <br>    invoice_id,<br>    invoice_total,<br>    (<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">AVG</span>(invoice_total) <span class="hljs-keyword">FROM</span> invoices) <span class="hljs-keyword">AS</span> invoice_average,<br>    <span class="hljs-comment">/*不能直接用聚合函数，因为“比较强势”，会压缩聚合结果为一条</span><br><span class="hljs-comment">    用括号+子查询(SELECT AVG(invoice_total) FROM invoices) </span><br><span class="hljs-comment">    将其作为一个数值结果 152.388235 加入主查询语句*/</span><br>    invoice_total <span class="hljs-operator">-</span> (<span class="hljs-keyword">SELECT</span> invoice_average) <span class="hljs-keyword">AS</span> difference<br>    <span class="hljs-comment">/*SELECT表达式里要用原列名，不能直接用别名invoice_average</span><br><span class="hljs-comment">    要用列别名的话用子查询（SELECT 同级的列别名）即可</span><br><span class="hljs-comment">    说真的，感觉这个子查询有点难以理解，但记住会用就行*/</span><br><span class="hljs-keyword">FROM</span> invoices<br></code></pre></td></tr></table></figure>

<p><strong>练习</strong></p>
<p>得到一个有如下列的表格：client_id, name, total_sales（各个客户的发票总额）, average（总平均发票额）, difference（前两个值的差）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">SELECT</span> <br>	client_id,<br>	name,<br>	(<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">SUM</span>(invoice_total) <span class="hljs-keyword">FROM</span> invoices <span class="hljs-keyword">WHERE</span> client_id <span class="hljs-operator">=</span> c.client_id ) <span class="hljs-keyword">AS</span> total_sales,<br>	(<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">AVG</span>(invoice_total) <span class="hljs-keyword">FROM</span> invoices) <span class="hljs-keyword">AS</span> average,<br>	(<span class="hljs-keyword">SELECT</span> total_sales <span class="hljs-operator">-</span> average) <span class="hljs-keyword">AS</span> difference<br><span class="hljs-keyword">FROM</span> clients c<br>    <br><span class="hljs-keyword">FROM</span> client c<br></code></pre></td></tr></table></figure>





<h3 id="10-FROM字句的子查询"><a href="#10-FROM字句的子查询" class="headerlink" title="10. FROM字句的子查询"></a>10. FROM字句的子查询</h3><p>子查询的结果同样可以充当一个“虚拟表”作为FROM语句中的来源表，即将筛选查询结果作为来源再进行进一步的筛选查询。但注意只有在子查询不太复杂时进行这样的嵌套，否则最好用后面讲的视图先把子查询结果储存起来再使用。</p>
<p><strong>案例</strong></p>
<p>将上一节练习里的查询结果当作来源表，查询其中 total_sales 非空的记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_invoicing;<br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <br><span class="hljs-keyword">FROM</span> (<br>    <span class="hljs-keyword">SELECT</span> <br>        client_id,<br>        name,<br>        (<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">SUM</span>(invoice_total) <span class="hljs-keyword">FROM</span> invoices <span class="hljs-keyword">WHERE</span> client_id <span class="hljs-operator">=</span> c.client_id) <span class="hljs-keyword">AS</span> total_sales,<br>        (<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">AVG</span>(invoice_total) <span class="hljs-keyword">FROM</span> invoices) <span class="hljs-keyword">AS</span> average,<br>        (<span class="hljs-keyword">SELECT</span> total_sales <span class="hljs-operator">-</span> average) <span class="hljs-keyword">AS</span> difference   <br>    <span class="hljs-keyword">FROM</span> clients c<br>) <span class="hljs-keyword">AS</span> sales_summury #necessary·<br><span class="hljs-comment">/* 在FROM中使用子查询，即使用 “派生表” 时，</span><br><span class="hljs-comment">必须给派生表取个别名（不管用不用），这是硬性要求，不写会报错：</span><br><span class="hljs-comment">Error Code: 1248. Every derived table（派生表、导出表）</span><br><span class="hljs-comment">must have its own alias */</span><br><span class="hljs-keyword">WHERE</span> total_sales <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br></code></pre></td></tr></table></figure>



<h2 id="【第七章】MySQL的基本函数"><a href="#【第七章】MySQL的基本函数" class="headerlink" title="【第七章】MySQL的基本函数"></a>【第七章】MySQL的基本函数</h2><h2 id="1-数值函数"><a href="#1-数值函数" class="headerlink" title="1. 数值函数"></a>1. 数值函数</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> ROUND(<span class="hljs-number">5.7365</span>, <span class="hljs-number">2</span>)  <span class="hljs-comment">-- 四舍五入</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">TRUNCATE</span>(<span class="hljs-number">5.7365</span>, <span class="hljs-number">2</span>)  <span class="hljs-comment">-- 截断</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">CEILING</span>(<span class="hljs-number">5.2</span>)  <span class="hljs-comment">-- 天花板函数，大于等于此数的最小整数</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">5.6</span>)  <span class="hljs-comment">-- 地板函数，小于等于此数的最大整数</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">ABS</span>(<span class="hljs-number">-5.2</span>)  <span class="hljs-comment">-- 绝对值</span><br><span class="hljs-keyword">SELECT</span> RAND()  <span class="hljs-comment">-- 随机函数，0到1的随机值</span><br></code></pre></td></tr></table></figure>

<h2 id="2-字符串函数"><a href="#2-字符串函数" class="headerlink" title="2. 字符串函数"></a>2. 字符串函数</h2><ol>
<li>LENGTH, UPPER, LOWER</li>
<li>TRIM, LTRIM, RTRIM</li>
<li>LEFT, RIGHT, SUBSTRING</li>
<li>LOCATE, REPLACE, 【CONCAT】</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 长度、转大小写：</span><br><span class="hljs-keyword">SELECT</span> LENGTH(<span class="hljs-string">&#x27;sky&#x27;</span>)  <span class="hljs-comment">-- 字符串字符个数/长度（LENGTH）</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">UPPER</span>(<span class="hljs-string">&#x27;sky&#x27;</span>)  <span class="hljs-comment">-- 转大写</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">LOWER</span>(<span class="hljs-string">&#x27;Sky&#x27;</span>)  <span class="hljs-comment">-- 转小写</span><br><br><span class="hljs-comment">-- 处理/修剪（trim）字符串前后的空格，L、R 表示 LEFT、RIGHT：</span><br><span class="hljs-keyword">SELECT</span> LTRIM(<span class="hljs-string">&#x27;  Sky&#x27;</span>)<br><span class="hljs-keyword">SELECT</span> RTRIM(<span class="hljs-string">&#x27;Sky  &#x27;</span>)<br><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">TRIM</span>(<span class="hljs-string">&#x27; Sky &#x27;</span>)<br><br><span class="hljs-comment">-- 切片</span><br><span class="hljs-comment">-- 取左边，取右边，取中间</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">LEFT</span>(<span class="hljs-string">&#x27;Kindergarden&#x27;</span>, <span class="hljs-number">4</span>)  <span class="hljs-comment">-- 取左边（LEFT）4个字符</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">RIGHT</span>(<span class="hljs-string">&#x27;Kindergarden&#x27;</span>, <span class="hljs-number">6</span>)  <span class="hljs-comment">-- 取右边（RIGHT）6个字符</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-string">&#x27;Kindergarden&#x27;</span>, <span class="hljs-number">7</span>, <span class="hljs-number">6</span>)  <br><span class="hljs-comment">-- 取中间从第7个开始的长度为6的子串（SUBSTRING）</span><br><span class="hljs-comment">-- 注意是从第1个（而非第0个）开始计数的</span><br><span class="hljs-comment">-- 省略第3参数（子串长度）则一直截取到最后</span><br><br><span class="hljs-comment">-- 定位</span><br><span class="hljs-keyword">SELECT</span> LOCATE(<span class="hljs-string">&#x27;gar&#x27;</span>, <span class="hljs-string">&#x27;Kindergarden&#x27;</span>)  <span class="hljs-comment">-- 定位（LOCATE）首次出现的位置</span><br><span class="hljs-comment">-- 没有的话返回0（其他编程语言大多返回-1，可能因为索引是从0开始的）</span><br><span class="hljs-comment">-- 这个定位/查找函数依然是不区分大小写的</span><br><br><span class="hljs-comment">-- 替换：</span><br><span class="hljs-keyword">SELECT</span> REPLACE(<span class="hljs-string">&#x27;Kindergarten&#x27;</span>, <span class="hljs-string">&#x27;garten&#x27;</span>, <span class="hljs-string">&#x27;garden&#x27;</span>)<br><br><span class="hljs-comment">-- 连接：</span><br>USE sql_store;<br><br><span class="hljs-keyword">SELECT</span> CONCAT(first_name, <span class="hljs-string">&#x27; &#x27;</span>, last_name) <span class="hljs-keyword">AS</span> full_name<br><span class="hljs-comment">-- concatenate v. 连接</span><br><span class="hljs-keyword">FROM</span> customers<br></code></pre></td></tr></table></figure>



<h2 id="3-MySQL中的日期函数"><a href="#3-MySQL中的日期函数" class="headerlink" title="3. MySQL中的日期函数"></a>3. MySQL中的日期函数</h2><ol>
<li>NOW, CURDATE, CURTIME</li>
<li>YEAR, MONTH, DAY, HOUR, MINUTE, SECOND, DAYNAME, MONTHNAME</li>
<li>EXTRACT(单位 FROM 日期时间对象)， 如 EXTRACT(YEAR FROM NOW())</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 当前时间</span><br><span class="hljs-keyword">SELECT</span> NOW()  <span class="hljs-comment">-- 2020-09-12 08:50:46</span><br><span class="hljs-keyword">SELECT</span> CURDATE()  <span class="hljs-comment">-- current date, 2020-09-12</span><br><span class="hljs-keyword">SELECT</span> CURTIME()  <span class="hljs-comment">-- current time, 08:50:46</span><br><br><span class="hljs-comment">-- 提取时间日期对象中的元素</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">YEAR</span>(NOW())  <span class="hljs-comment">-- 2020</span><br><span class="hljs-comment">-- 还有MONTH, DAY, HOUR, MINUTE, SECOND</span><br><br><span class="hljs-keyword">SELECT</span> DAYNAME(NOW())  <span class="hljs-comment">-- Saturday</span><br><span class="hljs-keyword">SELECT</span> MONTHNAME(NOW())  <span class="hljs-comment">-- September</span><br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> NOW())<br><span class="hljs-comment">-- EXTRACT(单位 FROM 日期时间对象)</span><br></code></pre></td></tr></table></figure>



<h2 id="4-格式化日期和时间"><a href="#4-格式化日期和时间" class="headerlink" title="4. 格式化日期和时间"></a>4. 格式化日期和时间</h2><p><code>DATE_FORMAT(date, format)</code> 将 date 根据 format 字符串进行格式化。</p>
<p><code>TIME_FORMAT(time, format)</code> 类似于 DATE_FORMAT 函数，但这里 format 字符串只能包含用于小时，分钟，秒和微秒的格式说明符。其他说明符产生一个 NULL 值或0。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> DATE_FORMAT(NOW(), <span class="hljs-string">&#x27;%M %d, %Y&#x27;</span>)  <span class="hljs-comment">-- September 12, 2020</span><br><span class="hljs-comment">-- 格式说明符里，大小写是不同的，这是目前SQL里第一次出现大小写不同的情况</span><br><span class="hljs-keyword">SELECT</span> TIME_FORMAT(NOW(), <span class="hljs-string">&#x27;%H:%i %p&#x27;</span>)  <span class="hljs-comment">-- 11:07 AM</span><br></code></pre></td></tr></table></figure>

<h2 id="5-计算日期和时间"><a href="#5-计算日期和时间" class="headerlink" title="5. 计算日期和时间"></a>5. 计算日期和时间</h2><p>有时需要对日期事件对象进行运算，如增加一天或算两个时间的差值之类，介绍一些最有用的日期时间计算函数：</p>
<ol>
<li>DATE_ADD, DATE_SUB</li>
<li>DATEDIFF</li>
<li>TIME_TO_SEC</li>
</ol>
<p>增加或减少一定的天数、月数、年数、小时数等等</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> DATE_ADD(NOW(), <span class="hljs-type">INTERVAL</span> <span class="hljs-number">-1</span> <span class="hljs-keyword">DAY</span>)<br><span class="hljs-keyword">SELECT</span> DATE_SUB(NOW(), <span class="hljs-type">INTERVAL</span> <span class="hljs-number">1</span> <span class="hljs-keyword">YEAR</span>)<br></code></pre></td></tr></table></figure>

<p>计算日期差异</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> DATEDIFF(<span class="hljs-string">&#x27;2019-01-01 09:00&#x27;</span>, <span class="hljs-string">&#x27;2019-01-05&#x27;</span>)  <span class="hljs-comment">-- -4</span><br><span class="hljs-comment">-- 会忽略时间部分，只算日期差异</span><br><br><span class="hljs-comment">-- 借助 TIME_TO_SEC 函数计算时间差异</span><br><span class="hljs-comment">-- TIME_TO_SEC：计算从 00:00 到某时间经历的秒数</span><br><br><span class="hljs-keyword">SELECT</span> TIME_TO_SEC(<span class="hljs-string">&#x27;09:00&#x27;</span>)  <span class="hljs-comment">-- 32400</span><br><span class="hljs-keyword">SELECT</span> TIME_TO_SEC(<span class="hljs-string">&#x27;09:00&#x27;</span>) <span class="hljs-operator">-</span> TIME_TO_SEC(<span class="hljs-string">&#x27;09:02&#x27;</span>)  <span class="hljs-comment">-- -120</span><br></code></pre></td></tr></table></figure>

<h2 id="6-IFNULL和COALESCE函数"><a href="#6-IFNULL和COALESCE函数" class="headerlink" title="6. IFNULL和COALESCE函数"></a>6. IFNULL和COALESCE函数</h2><p>两个用来替换空值的函数：IFNULL, COALESCE. 后者更灵活</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><span class="hljs-keyword">SELECT</span><br>	order_id,<br>	IFNULL(shipper_id,<span class="hljs-string">&#x27;Not Assigned&#x27;</span>) <span class="hljs-keyword">AS</span> shipper<br><span class="hljs-keyword">FROM</span> orders<br> <span class="hljs-comment">/* If expr1 is not NULL, IFNULL() returns expr1; </span><br><span class="hljs-comment">    otherwise it returns expr2. */</span><br>    <br>USE sql_store;<br><span class="hljs-keyword">SELECT</span> <br>    order_id,<br>    <span class="hljs-built_in">COALESCE</span>(shipper_id, comments, <span class="hljs-string">&#x27;Not Assigned&#x27;</span>) <span class="hljs-keyword">AS</span> shipper<br>    <span class="hljs-comment">/* Returns the first non-NULL value in the list, </span><br><span class="hljs-comment">    or NULL if there are no non-NULLvalues. */</span><br>    <span class="hljs-comment">-- COALESCE 函数是返回一系列值中的首个非空值，更灵活</span><br><span class="hljs-keyword">FROM</span> orders   <br></code></pre></td></tr></table></figure>



<h2 id="7-IF函数"><a href="#7-IF函数" class="headerlink" title="7. IF函数"></a>7. IF函数</h2><p><code>IF(条件表达式, 返回值1, 返回值2)</code> 返回值可以是任何东西，数值 文本 日期时间 空值null 均可</p>
<p><strong>练习</strong></p>
<p>得到包含如下字段的表：</p>
<ol>
<li>product_id</li>
<li>name (产品名称)</li>
<li>orders (该产品出现在订单中的次数)</li>
<li>frequency (根据是否多于一次而分类为’Once’或’Many times’)</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><span class="hljs-keyword">SELECT</span> <br>	product_id,<br>    name,<br>    <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> orders,<br>    IF(<span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>)<span class="hljs-operator">=</span><span class="hljs-number">1</span>,<span class="hljs-string">&#x27;Once&#x27;</span>,<span class="hljs-string">&#x27;Many times&#x27;</span>) <span class="hljs-keyword">AS</span> frequency<br><span class="hljs-keyword">FROM</span> products  <br><span class="hljs-keyword">JOIN</span> order_items <span class="hljs-keyword">USING</span>(product_id)<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> product_id<br><br><span class="hljs-comment">-- 注意：先分组(group by)再计数(count)</span><br></code></pre></td></tr></table></figure>

<h2 id="8-CASE运算符"><a href="#8-CASE运算符" class="headerlink" title="8. CASE运算符"></a>8. CASE运算符</h2><p>当分类多余两种时，可以用IF嵌套，也可以用CASE语句，后者可读性更好</p>
<p>CASE语句结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CASE</span> <br>    <span class="hljs-keyword">WHEN</span> …… <span class="hljs-keyword">THEN</span> ……<br>    <span class="hljs-keyword">WHEN</span> …… <span class="hljs-keyword">THEN</span> ……<br>    <span class="hljs-keyword">WHEN</span> …… <span class="hljs-keyword">THEN</span> ……<br>    ……<br>    [<span class="hljs-keyword">ELSE</span> ……] （<span class="hljs-keyword">ELSE</span>子句是可选的）<br><span class="hljs-keyword">END</span><br></code></pre></td></tr></table></figure>

<p><strong>练习</strong></p>
<p>得到包含如下字段的表：customer, points, category（根据积分 &lt;2k、2k~3k（包含两端）、&gt;3k 分为青铜、白银和黄金用户）</p>
<p>之前也是用过 UNION 法，分别查询增加分类字段再合并，很麻烦。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE sql_store;<br><span class="hljs-keyword">SELECT</span> <br>	CONCAT(first_name,<span class="hljs-string">&#x27;&#x27;</span>,last_name) <span class="hljs-keyword">AS</span> customer,<br>	points,<br>	<span class="hljs-keyword">CASE</span><br>		<span class="hljs-keyword">WHEN</span> points <span class="hljs-operator">&lt;</span> <span class="hljs-number">2000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;Bronze&#x27;</span><br>        <span class="hljs-keyword">WHEN</span> points <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">2000</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">3000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;Silver&#x27;</span><br>        <span class="hljs-keyword">WHEN</span> points <span class="hljs-operator">&gt;</span> <span class="hljs-number">3000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;Gold&#x27;</span><br>    <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> category<br><span class="hljs-keyword">FROM</span> customers<br><span class="hljs-keyword">ORDER</span>  <span class="hljs-keyword">BY</span> points <span class="hljs-keyword">DESC</span><br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6/" class="category-chain-item">数据科学</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/MySQL/" class="print-no-link">#MySQL</a>
      
        <a href="/tags/Coding/" class="print-no-link">#Coding</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>MySQL读书笔记</div>
      <div>http://example.com/2023/11/05/sql-mosh/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>zhizhia</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年11月5日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/11/07/%E5%AE%9E%E7%94%A8%E6%9C%80%E4%BC%98%E5%8C%96/" title="实用最优化">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">实用最优化</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/11/02/%E6%B3%9B%E5%87%BD%E5%88%86%E6%9E%90/" title="泛函分析">
                        <span class="hidden-mobile">泛函分析</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"7DcKf76sOwcvZ74oFU6BeMvA-gzGzoHsz","appKey":"G62zSvWl1OMBRu3NWJjOea38","path":"window.location.pathname","placeholder":"吐槽","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
